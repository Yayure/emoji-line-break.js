<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Download your custom file</title>
<meta name="description" content="">
<meta name="keywords" content="">
<style type="text/css">
    textarea {
        width: 200px;
        height: 200px;
    }

    button {
        height: 36px;
        min-width: 64px;
        padding: 0 16px;
    }

    a {
        margin-top: 20px;
        width: fit-content;
        flex: 1 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 23px;
        height: 52px;
        font-size: 18px;
        border-radius: 4px;
        box-shadow:0px 3px 1px -2px rgba(0, 0, 0, 0.2), 0px 2px 2px 0px rgba(0, 0, 0, 0.14), 0px 1px 5px 0px rgba(0, 0, 0, 0.12);
        background-color: #607d8b !important;
        border-color: #607d8b !important;
        color: #fff;
        font-weight: 700;
    }
</style>
</head>
<body>
</body>
<script type="text/javascript">
    function generateDownloadLink(filename, text, type) {
        let element = document.createElement('a');
        let prefix = FILETYPE === 'esm' ? '"use strict";export default ' : '"use strict";module.exports = ';
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(prefix + text));

        filename = filename.replace(/.js/, (p1) => {
            let _prefix = FILETYPE === 'esm' ? '.esm' : '.common'
            return _prefix + p1
        })

        element.setAttribute('download', filename);

        element.innerText = 'Download ' + filename;
        // element.style.display = 'none';
        document.body.appendChild(element);

        // element.click();

        // document.body.removeChild(element);
    }

    function generateExactRegex(set) {
        let exactRegex = [];
        let escape = /[\-\\\[\]$^]/;

        for (let item in set) {
            let regExStr = set[item].reduce((p1, p2) => {
                escape.test(p2) && (p2 = '\\' + p2);

                return p1 + p2
            }, '')
            exactRegex.push({
                ratio: +item,
                regex: `[${regExStr}]`
            });
        }

        return exactRegex
    }

    const BASE = {
        letter: ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'],
        numbers: [0,1,2,3,4,5,6,7,8,9],
        punctuation: ['`', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '=', '+', '/', '<', '>', ':', '?', '\\', '[', ']', '{', '}', '|','\'', '"', ';', ',', '.', '~', '_', ' ', 'Àê']
    }

    const BASECHAR = {
        en: {
            serif: 'Àê',
            'sans-serif': '0',
            Arial: 'a',
            cursive: 'a'
        },
        zh: {
            serif: 'Áà±',
            'sans-serif': 'Áà±',
            Arial: 'Áà±',
            cursive: 'Áà±'
        },
        emoji: 'üòò'
    }
    const FILETYPE = 'commonjs';         // esm, commonjs

    const PRECISION = 3;
    let baseFontSize= '16px';
    let fontWeight= ['lighter', 'normal', 'bold'];
    let fontFamily= ['serif', 'sans-serif', 'Arial', 'cursive'];

    function generateUnitBase(lang) {
        let ctx = document.createElement('canvas').getContext("2d");
        let ctxOffset = document.createElement('canvas').getContext("2d");
        let measureChar = '';
        let result = {};

        fontWeight.forEach(fw => {
            fontFamily.forEach(fm => {
                measureChar = BASECHAR[lang][fm];

                ctx.font = `${fw} ${baseFontSize} ${fm}`
                ctxOffset.font = `${fw} ${baseFontSize.replace(/\d+/, p1 => (+p1 + 1))} ${fm}`;

                let baseW = ctx.measureText(measureChar).width;

                !result[fw] && (result[fw] = {})

                result[fw][fm] = {
                    fontSize: baseFontSize,
                    baseWidth: +baseW.toFixed(PRECISION),
                    offset: +(ctxOffset.measureText(measureChar).width - baseW).toFixed(PRECISION),
                    emojiRatio: +(ctx.measureText(BASECHAR.emoji).width / baseW).toFixed(PRECISION)
                }
            })
        })
       
        console.log(`unit-base-${lang}:`, result)
        generateDownloadLink(`unit-base.${lang}.js`, JSON.stringify(result))
    }


    function generateLangRegex(lang, extendChars) {
        let ctx = document.createElement('canvas').getContext("2d");
        let measureChar = '';
        let result = {};
        let amountChars = BASE.letter.concat(BASE.punctuation, BASE.numbers, BASE.letter.map(lt => lt.toUpperCase()), extendChars || []);

        fontWeight.forEach(fw => {
            fontFamily.forEach(fm => {
                measureChar = BASECHAR[lang][fm];

                ctx.font = `${fw} ${baseFontSize} ${fm}`;
                
                let baseW = ctx.measureText(measureChar).width;

                let ratset = {};
                amountChars.forEach(item => {
                    let itemrat = (ctx.measureText(item).width / baseW).toFixed(PRECISION);

                    !ratset[itemrat] && (ratset[itemrat] = [])
                    ratset[itemrat].push(item)
                });

                !result[fw] && (result[fw] = {})

                result[fw][fm] = generateExactRegex(ratset).filter(item => item.ratio !== 1)
            })
        })
        
        console.log(`exact-regex-${lang}:`, result)
        generateDownloadLink(`exact-regex.${lang}.js`, JSON.stringify(result))

    }


    generateUnitBase('zh');
    generateUnitBase('en');

    generateLangRegex('zh', ['¬∑', 'ÔºÅ', 'Ôø•', '‚Ä¶‚Ä¶', 'Ôºà', 'Ôºâ', '‚Äî', '„ÄÇ', '„Äê', '„Äë', 'Ôºö', '‚Äú', '‚Äù', '‚Äò', '‚Äô', '„Ää', '„Äã', 'Ôºü', 'Ôºå']);
    generateLangRegex('en');
</script>
</html>